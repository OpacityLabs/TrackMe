name: Build & Push TrackMe Docker Image

on:
  push:
    branches:
      - master
      - develop
      - staging

jobs:
  build-and-push:
    runs-on: dind-scale-set-secure

    env:
      IMAGE_REPO: opacitylabs/trackme

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set build vars
        id: vars
        shell: sh
        run: |
          # Build tags based on branch
          SHORT_SHA="$(echo "${GITHUB_SHA}" | cut -c1-7)"
          DATE="$(date -u +%Y%m%d)"
          case "${GITHUB_REF_NAME}" in
            master)    CHANNEL_TAG="latest"  ;;
            develop)     CHANNEL_TAG="dev"     ;;
            staging) CHANNEL_TAG="staging" ;;
            *) echo "Unsupported branch: ${GITHUB_REF_NAME}"; exit 1 ;;
          esac
          echo "SHORT_SHA=${SHORT_SHA}"     >> "$GITHUB_ENV"
          echo "CHANNEL_TAG=${CHANNEL_TAG}" >> "$GITHUB_ENV"
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_SECRET }}

      - name: Build image (multi-tag)
        run: |
          echo "Building ${IMAGE_REPO}:${CHANNEL_TAG}"
          docker build \
            --build-arg CLERK_PUBLISHABLE_KEY="${CLERK_PUBLISHABLE_KEY}" \
            --label org.opencontainers.image.revision="${GITHUB_SHA}" \
            --label org.opencontainers.image.source="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}" \
            -t "${IMAGE_REPO}:${CHANNEL_TAG}" \
            -t "${IMAGE_REPO}:${CHANNEL_TAG}-${SHORT_SHA}" \
            -f Dockerfile .
      - name: Push tags
        run: |
          for TAG in "${CHANNEL_TAG}" "${CHANNEL_TAG}-${SHORT_SHA}"; do
            echo "Pushing ${IMAGE_REPO}:${TAG}"
            docker push "${IMAGE_REPO}:${TAG}"
          done
